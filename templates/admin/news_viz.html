{% extends "admin/base.html" %}

{% block title %}News Analytics - Admin Panel{% endblock %}
{% block page_title %}News Analytics & Visualizations{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('admin.admin_dashboard') }}">Admin</a>
<span class="separator">/</span>
<span>Analytics</span>
{% endblock %}

{% block content %}
<!-- Error Display -->
{% if error %}
<div class="alert alert-error">
    <i class="fas fa-exclamation-triangle"></i>
    <span>{{ error }}</span>
    <button class="alert-close" onclick="this.parentElement.style.display='none'">
        <i class="fas fa-times"></i>
    </button>
</div>
{% endif %}

<!-- Analytics Header -->
<div class="page-header">
    <div class="header-content">
        <h1>News Analytics Dashboard</h1>
        <p>Comprehensive analysis and visualizations of news data</p>
    </div>
    <div class="header-actions">
        <button class="btn btn-secondary" onclick="exportCharts()">
            <i class="fas fa-download"></i>
            Export Charts
        </button>
        <button class="btn btn-primary" onclick="refreshAnalytics()">
            <i class="fas fa-sync-alt"></i>
            Refresh Data
        </button>
    </div>
</div>

<!-- Analytics Overview -->
<div class="analytics-overview">
    <div class="overview-stats">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-chart-pie"></i>
            </div>
            <div class="stat-content">
                <h3>{{ chart_data.category_distribution|length if chart_data else 0 }}</h3>
                <p>Categories Analyzed</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-newspaper"></i>
            </div>
            <div class="stat-content">
                <h3>{{ sample_count or 0 }}</h3>
                <p>Sample Articles</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <h3>{{ chart_data.sentiment_distribution|length if chart_data else 0 }}</h3>
                <p>Sentiment Categories</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="stat-content">
                <h3>{{ chart_data.fake_vs_real_ratio|length if chart_data else 0 }}</h3>
                <p>News Classification</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts Container -->
<div class="charts-container">
    <div class="charts-grid">
        <!-- Category Distribution -->
        <div class="chart-section">
            <div class="chart-header">
                <h3>News by Category</h3>
                <p>Distribution of articles across different news categories</p>
            </div>
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
        
        <!-- Sentiment Distribution -->
        <div class="chart-section">
            <div class="chart-header">
                <h3>Sentiment Analysis</h3>
                <p>Sentiment score distribution across all articles</p>
            </div>
            <div class="chart-container">
                <canvas id="sentimentChart"></canvas>
            </div>
        </div>
        
        <!-- Fake vs Real News -->
        <div class="chart-section">
            <div class="chart-header">
                <h3>Fake vs Real News Ratio</h3>
                <p>Proportion of fake news vs legitimate articles</p>
            </div>
            <div class="chart-container">
                <canvas id="fakeRealChart"></canvas>
            </div>
        </div>
        
        <!-- Credibility Distribution -->
        <div class="chart-section">
            <div class="chart-header">
                <h3>Credibility Score Distribution</h3>
                <p>How credibility scores are distributed across articles</p>
            </div>
            <div class="chart-container">
                <canvas id="credibilityChart"></canvas>
            </div>
        </div>
        
        <!-- News per Source -->
        <div class="chart-section full-width">
            <div class="chart-header">
                <h3>Top News Sources</h3>
                <p>Number of articles published by each news source</p>
            </div>
            <div class="chart-container">
                <canvas id="sourceChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Data Summary Table -->
<div class="data-summary-section">
    <div class="section-header">
        <h2>Data Summary</h2>
        <button class="btn btn-sm btn-outline" onclick="toggleSummaryTable()">
            <i class="fas fa-table"></i>
            Toggle Table View
        </button>
    </div>
    
    <div class="summary-content" id="summary-content">
        <!-- Charts will be populated by JavaScript -->
        <div class="loading-charts">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading chart data...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize analytics page
document.addEventListener('DOMContentLoaded', function() {
    initializeAnalytics();
});

function initializeAnalytics() {
    // Load chart data
    loadChartData();
    
    // Set up auto-refresh
    setInterval(() => {
        if (document.visibilityState === 'visible') {
            refreshAnalytics();
        }
    }, 300000); // 5 minutes
}

function loadChartData() {
    fetch('/admin/news/charts/data')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showNotification('Failed to load chart data: ' + data.error, 'error');
                return;
            }
            
            initializeCharts(data);
            updateSummaryTable(data);
        })
        .catch(error => {
            console.error('Failed to load chart data:', error);
            showNotification('Failed to load chart data', 'error');
        });
}

function initializeCharts(chartData) {
    if (!chartData) return;
    
    // Category Distribution Chart
    if (chartData.category_distribution && chartData.category_distribution.length > 0) {
        initializeCategoryChart(chartData.category_distribution);
    }
    
    // Sentiment Distribution Chart
    if (chartData.sentiment_distribution && chartData.sentiment_distribution.length > 0) {
        initializeSentimentChart(chartData.sentiment_distribution);
    }
    
    // Fake vs Real News Chart
    if (chartData.fake_vs_real_ratio && chartData.fake_vs_real_ratio.length > 0) {
        initializeFakeRealChart(chartData.fake_vs_real_ratio);
    }
    
    // Credibility Distribution Chart
    if (chartData.credibility_distribution && chartData.credibility_distribution.length > 0) {
        initializeCredibilityChart(chartData.credibility_distribution);
    }
    
    // News per Source Chart
    if (chartData.news_per_source && chartData.news_per_source.length > 0) {
        initializeSourceChart(chartData.news_per_source);
    }
}

function initializeCategoryChart(data) {
    const ctx = document.getElementById('categoryChart');
    if (!ctx) return;
    
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.map(item => item.category || 'Unknown'),
            datasets: [{
                data: data.map(item => item.count),
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', 
                    '#4BC0C0', '#9966FF', '#FF9F40',
                    '#FF6B6B', '#4ECDC4', '#45B7D1'
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'News Distribution by Category',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });
}

function initializeSentimentChart(data) {
    const ctx = document.getElementById('sentimentChart');
    if (!ctx) return;
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(item => item.sentiment),
            datasets: [{
                label: 'Number of Articles',
                data: data.map(item => item.count),
                backgroundColor: '#36A2EB',
                borderColor: '#2563eb',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Sentiment Distribution',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function initializeFakeRealChart(data) {
    const ctx = document.getElementById('fakeRealChart');
    if (!ctx) return;
    
    const colors = data.map(item => 
        item.type === 'Real News' ? '#10b981' : '#ef4444'
    );
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(item => item.type),
            datasets: [{
                data: data.map(item => item.count),
                backgroundColor: colors,
                borderWidth: 3,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Fake vs Real News Distribution',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });
}

function initializeCredibilityChart(data) {
    const ctx = document.getElementById('credibilityChart');
    if (!ctx) return;
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(item => item.range),
            datasets: [{
                label: 'Number of Articles',
                data: data.map(item => item.count),
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Credibility Score Distribution',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function initializeSourceChart(data) {
    const ctx = document.getElementById('sourceChart');
    if (!ctx) return;
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(item => item.source),
            datasets: [{
                label: 'Articles Published',
                data: data.map(item => item.count),
                backgroundColor: '#FFCE56',
                borderColor: '#f59e0b',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Top News Sources by Article Count',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function updateSummaryTable(chartData) {
    const summaryContent = document.getElementById('summary-content');
    if (!summaryContent) return;
    
    let html = '<div class="summary-table-container">';
    
    // Category Summary
    if (chartData.category_distribution) {
        html += '<div class="summary-section">';
        html += '<h4>Category Distribution</h4>';
        html += '<table class="summary-table">';
        html += '<thead><tr><th>Category</th><th>Count</th><th>Percentage</th></tr></thead>';
        html += '<tbody>';
        
        const total = chartData.category_distribution.reduce((sum, item) => sum + item.count, 0);
        chartData.category_distribution.forEach(item => {
            const percentage = ((item.count / total) * 100).toFixed(1);
            html += `<tr><td>${escapeHtml(item.category)}</td><td>${item.count}</td><td>${percentage}%</td></tr>`;
        });
        
        html += '</tbody></table></div>';
    }
    
    // Sentiment Summary
    if (chartData.sentiment_distribution) {
        html += '<div class="summary-section">';
        html += '<h4>Sentiment Analysis</h4>';
        html += '<table class="summary-table">';
        html += '<thead><tr><th>Sentiment</th><th>Count</th><th>Percentage</th></tr></thead>';
        html += '<tbody>';
        
        const total = chartData.sentiment_distribution.reduce((sum, item) => sum + item.count, 0);
        chartData.sentiment_distribution.forEach(item => {
            const percentage = ((item.count / total) * 100).toFixed(1);
            html += `<tr><td>${escapeHtml(item.sentiment)}</td><td>${item.count}</td><td>${percentage}%</td></tr>`;
        });
        
        html += '</tbody></table></div>';
    }
    
    html += '</div>';
    summaryContent.innerHTML = html;
}

function refreshAnalytics() {
    loadChartData();
    showNotification('Analytics data refreshed', 'success');
}

function exportCharts() {
    showNotification('Export functionality coming soon', 'info');
}

function toggleSummaryTable() {
    const summaryContent = document.getElementById('summary-content');
    if (summaryContent) {
        summaryContent.style.display = summaryContent.style.display === 'none' ? 'block' : 'none';
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
