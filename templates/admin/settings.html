{% extends "admin/base.html" %}

{% block title %}Settings - Admin Panel{% endblock %}
{% block page_title %}Admin Settings{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('admin.admin_dashboard') }}">Admin</a>
<span class="separator">/</span>
<span>Settings</span>
{% endblock %}

{% block content %}
<!-- Settings Header -->
<div class="page-header">
    <div class="header-content">
        <h1>Admin Settings</h1>
        <p>Configure system settings and admin preferences</p>
    </div>
    <div class="header-actions">
        <button class="btn btn-primary" onclick="saveAllSettings()">
            <i class="fas fa-save"></i>
            Save Settings
        </button>
    </div>
</div>

<!-- Settings Sections -->
<div class="settings-container">
    <!-- General Settings -->
    <div class="settings-section">
        <div class="section-header">
            <h2>
                <i class="fas fa-cog"></i>
                General Settings
            </h2>
            <p>Basic system configuration and preferences</p>
        </div>
        
        <div class="settings-grid">
            <div class="setting-group">
                <label for="site-name">Site Name</label>
                <input type="text" id="site-name" value="PSLVNews Admin" placeholder="Enter site name">
                <small>The name displayed in the admin panel header</small>
            </div>
            
            <div class="setting-group">
                <label for="admin-email">Admin Email</label>
                <input type="email" id="admin-email" value="admin@pslvnews.com" placeholder="Enter admin email">
                <small>Primary admin contact email</small>
            </div>
            
            <div class="setting-group">
                <label for="timezone">Timezone</label>
                <select id="timezone">
                    <option value="UTC">UTC</option>
                    <option value="America/New_York">Eastern Time</option>
                    <option value="America/Chicago">Central Time</option>
                    <option value="America/Denver">Mountain Time</option>
                    <option value="America/Los_Angeles">Pacific Time</option>
                    <option value="Europe/London">London</option>
                    <option value="Asia/Kolkata">India (IST)</option>
                </select>
                <small>Default timezone for the system</small>
            </div>
            
            <div class="setting-group">
                <label for="language">Language</label>
                <select id="language">
                    <option value="en">English</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="hi">Hindi</option>
                </select>
                <small>Default language for the admin interface</small>
            </div>
        </div>
    </div>

    <!-- Database Settings -->
    <div class="settings-section">
        <div class="section-header">
            <h2>
                <i class="fas fa-database"></i>
                Database Settings
            </h2>
            <p>Database connection and performance settings</p>
        </div>
        
        <div class="settings-grid">
            <div class="setting-group">
                <label for="db-connection">Database Connection</label>
                <input type="text" id="db-connection" value="MongoDB Atlas" readonly>
                <small>Current database connection type</small>
            </div>
            
            <div class="setting-group">
                <label for="cache-timeout">Cache Timeout (minutes)</label>
                <input type="number" id="cache-timeout" value="30" min="5" max="1440">
                <small>How long to cache dashboard data</small>
            </div>
            
            <div class="setting-group">
                <label for="auto-refresh">Auto Refresh Interval</label>
                <select id="auto-refresh">
                    <option value="0">Disabled</option>
                    <option value="60">1 minute</option>
                    <option value="300">5 minutes</option>
                    <option value="600">10 minutes</option>
                    <option value="1800">30 minutes</option>
                </select>
                <small>Automatic dashboard refresh interval</small>
            </div>
            
            <div class="setting-group">
                <label for="max-records">Max Records per Page</label>
                <input type="number" id="max-records" value="50" min="10" max="500">
                <small>Maximum records to display in tables</small>
            </div>
        </div>
    </div>

    <!-- Security Settings -->
    <div class="settings-section">
        <div class="section-header">
            <h2>
                <i class="fas fa-shield-alt"></i>
                Security Settings
            </h2>
            <p>Security and access control configuration</p>
        </div>
        
        <div class="settings-grid">
            <div class="setting-group">
                <label for="session-timeout">Session Timeout (hours)</label>
                <input type="number" id="session-timeout" value="8" min="1" max="168">
                <small>How long admin sessions remain active</small>
            </div>
            
            <div class="setting-group">
                <label for="max-login-attempts">Max Login Attempts</label>
                <input type="number" id="max-login-attempts" value="5" min="3" max="10">
                <small>Maximum failed login attempts before lockout</small>
            </div>
            
            <div class="setting-group">
                <label for="require-2fa">Require 2FA for Admins</label>
                <select id="require-2fa">
                    <option value="false">No</option>
                    <option value="true">Yes</option>
                </select>
                <small>Require two-factor authentication for admin users</small>
            </div>
            
            <div class="setting-group">
                <label for="audit-logging">Audit Logging</label>
                <select id="audit-logging">
                    <option value="true">Enabled</option>
                    <option value="false">Disabled</option>
                </select>
                <small>Log all admin actions for security audit</small>
            </div>
        </div>
    </div>

    <!-- Notification Settings -->
    <div class="settings-section">
        <div class="section-header">
            <h2>
                <i class="fas fa-bell"></i>
                Notification Settings
            </h2>
            <p>Configure system notifications and alerts</p>
        </div>
        
        <div class="settings-grid">
            <div class="setting-group">
                <label for="email-notifications">Email Notifications</label>
                <select id="email-notifications">
                    <option value="true">Enabled</option>
                    <option value="false">Disabled</option>
                </select>
                <small>Send email notifications for important events</small>
            </div>
            
            <div class="setting-group">
                <label for="notification-email">Notification Email</label>
                <input type="email" id="notification-email" value="admin@pslvnews.com">
                <small>Email address to receive system notifications</small>
            </div>
            
            <div class="setting-group">
                <label for="fake-news-alerts">Fake News Alerts</label>
                <select id="fake-news-alerts">
                    <option value="true">Enabled</option>
                    <option value="false">Disabled</option>
                </select>
                <small>Alert when high amounts of fake news are detected</small>
            </div>
            
            <div class="setting-group">
                <label for="system-health-alerts">System Health Alerts</label>
                <select id="system-health-alerts">
                    <option value="true">Enabled</option>
                    <option value="false">Disabled</option>
                </select>
                <small>Alert when system health issues are detected</small>
            </div>
        </div>
    </div>

    <!-- API Settings -->
    <div class="settings-section">
        <div class="section-header">
            <h2>
                <i class="fas fa-code"></i>
                API Settings
            </h2>
            <p>External API integration and rate limiting</p>
        </div>
        
        <div class="settings-grid">
            <div class="setting-group">
                <label for="api-rate-limit">API Rate Limit (requests/minute)</label>
                <input type="number" id="api-rate-limit" value="100" min="10" max="1000">
                <small>Maximum API requests per minute per user</small>
            </div>
            
            <div class="setting-group">
                <label for="enable-api">Enable Public API</label>
                <select id="enable-api">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
                <small>Allow public access to news data API</small>
            </div>
            
            <div class="setting-group">
                <label for="cors-origins">CORS Origins</label>
                <textarea id="cors-origins" rows="3" placeholder="https://example.com, https://app.example.com">https://localhost:3000, http://localhost:8080</textarea>
                <small>Allowed origins for CORS requests (comma-separated)</small>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="settings-actions">
    <button class="btn btn-outline" onclick="resetToDefaults()">
        <i class="fas fa-undo"></i>
        Reset to Defaults
    </button>
    
    <button class="btn btn-secondary" onclick="exportSettings()">
        <i class="fas fa-download"></i>
        Export Settings
    </button>
    
    <button class="btn btn-primary" onclick="saveAllSettings()">
        <i class="fas fa-save"></i>
        Save All Settings
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize settings page
document.addEventListener('DOMContentLoaded', function() {
    initializeSettings();
});

function initializeSettings() {
    // Load saved settings from localStorage
    loadSettings();
    
    // Set up auto-save (optional)
    let autoSaveTimeout;
    document.querySelectorAll('input, select, textarea').forEach(element => {
        element.addEventListener('change', function() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(saveSettings, 2000);
        });
    });
}

function saveAllSettings() {
    const settings = {};
    
    // Collect all settings
    document.querySelectorAll('input, select, textarea').forEach(element => {
        settings[element.id] = element.value;
    });
    
    // Save to localStorage
    localStorage.setItem('adminSettings', JSON.stringify(settings));
    
    // Show notification
    if (typeof showNotification === 'function') {
        showNotification('Settings saved successfully', 'success');
    }
    
    console.log('Settings saved:', settings);
}

function saveSettings() {
    saveAllSettings();
}

function loadSettings() {
    try {
        const savedSettings = localStorage.getItem('adminSettings');
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            
            // Apply settings to form elements
            Object.keys(settings).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = settings[key];
                }
            });
        }
    } catch (error) {
        console.error('Failed to load settings:', error);
    }
}

function resetToDefaults() {
    if (!confirm('Are you sure you want to reset all settings to default values? This action cannot be undone.')) {
        return;
    }
    
    // Clear localStorage
    localStorage.removeItem('adminSettings');
    
    // Reset form values to defaults
    document.querySelectorAll('input, select, textarea').forEach(element => {
        switch (element.id) {
            case 'site-name':
                element.value = 'PSLVNews Admin';
                break;
            case 'admin-email':
                element.value = 'admin@pslvnews.com';
                break;
            case 'timezone':
                element.value = 'UTC';
                break;
            case 'language':
                element.value = 'en';
                break;
            case 'cache-timeout':
                element.value = '30';
                break;
            case 'auto-refresh':
                element.value = '300';
                break;
            case 'max-records':
                element.value = '50';
                break;
            case 'session-timeout':
                element.value = '8';
                break;
            case 'max-login-attempts':
                element.value = '5';
                break;
            case 'require-2fa':
                element.value = 'false';
                break;
            case 'audit-logging':
                element.value = 'true';
                break;
            case 'email-notifications':
                element.value = 'true';
                break;
            case 'notification-email':
                element.value = 'admin@pslvnews.com';
                break;
            case 'fake-news-alerts':
                element.value = 'true';
                break;
            case 'system-health-alerts':
                element.value = 'true';
                break;
            case 'api-rate-limit':
                element.value = '100';
                break;
            case 'enable-api':
                element.value = 'false';
                break;
            case 'cors-origins':
                element.value = 'https://localhost:3000, http://localhost:8080';
                break;
        }
    });
    
    if (typeof showNotification === 'function') {
        showNotification('Settings reset to defaults', 'success');
    }
}

function exportSettings() {
    const settings = {};
    
    // Collect all settings
    document.querySelectorAll('input, select, textarea').forEach(element => {
        settings[element.id] = element.value;
    });
    
    // Create and download JSON file
    const dataStr = JSON.stringify(settings, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = 'admin-settings.json';
    link.click();
    
    if (typeof showNotification === 'function') {
        showNotification('Settings exported successfully', 'success');
    }
}

// Auto-save functionality
let autoSaveInterval;
function startAutoSave() {
    autoSaveInterval = setInterval(() => {
        saveSettings();
    }, 60000); // Auto-save every minute
}

function stopAutoSave() {
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
    }
}

// Start auto-save when page loads
document.addEventListener('DOMContentLoaded', function() {
    startAutoSave();
});

// Stop auto-save when page unloads
window.addEventListener('beforeunload', function() {
    saveSettings();
    stopAutoSave();
});
</script>
{% endblock %}
