{% extends "admin/base.html" %}

{% block title %}User Management - Admin Panel{% endblock %}
{% block page_title %}User Management{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('admin.admin_dashboard') }}">Admin</a>
<span class="separator">/</span>
<span>Users</span>
{% endblock %}

{% block content %}
<!-- Error Display -->
{% if error %}
<div class="alert alert-error">
    <i class="fas fa-exclamation-triangle"></i>
    <span>{{ error }}</span>
    <button class="alert-close" onclick="this.parentElement.style.display='none'">
        <i class="fas fa-times"></i>
    </button>
</div>
{% endif %}

<!-- User Management Header -->
<div class="page-header">
    <div class="header-content">
        <h1>User Management</h1>
        <p>Manage user accounts, roles, and permissions</p>
    </div>
    <div class="header-actions">
        <button class="btn btn-secondary" onclick="exportUsersData()">
            <i class="fas fa-download"></i>
            Export Users
        </button>
        <button class="btn btn-primary" onclick="refreshUsers()">
            <i class="fas fa-sync-alt"></i>
            Refresh
        </button>
    </div>
</div>

<!-- User Statistics -->
<div class="user-stats">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <h3>{{ user_metrics.total_users or 0 }}</h3>
                <p>Total Users</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-content">
                <h3>{{ user_metrics.active_users or 0 }}</h3>
                <p>Active Users (30 days)</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-user-shield"></i>
            </div>
            <div class="stat-content">
                <h3>{{ (user_metrics.role_distribution|length) if user_metrics else 0 }}</h3>
                <p>User Roles</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-chart-pie"></i>
            </div>
            <div class="stat-content">
                <h3>{{ users_data.total_count or 0 }}</h3>
                <p>Showing on Page</p>
            </div>
        </div>
    </div>
</div>

<!-- Filters and Controls -->
<div class="filters-section">
    <div class="filters-grid">
        <div class="filter-group">
            <label for="role-filter">Role</label>
            <select id="role-filter" onchange="filterUsers()">
                <option value="all" {% if current_role == 'all' %}selected{% endif %}>All Roles</option>
                <option value="admin" {% if current_role == 'admin' %}selected{% endif %}>Admin</option>
                <option value="news_reporter" {% if current_role == 'news_reporter' %}selected{% endif %}>News Reporter</option>
                <option value="user" {% if current_role == 'user' %}selected{% endif %}>User</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="limit-select">Items per page</label>
            <select id="limit-select" onchange="changeLimit()">
                <option value="20" {% if users_data.total_count <= 20 %}selected{% endif %}>20</option>
                <option value="50" {% if users_data.total_count > 20 and users_data.total_count <= 50 %}selected{% endif %}>50</option>
                <option value="100" {% if users_data.total_count > 50 %}selected{% endif %}>100</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>&nbsp;</label>
            <button class="btn btn-outline" onclick="clearFilters()">
                <i class="fas fa-times"></i>
                Clear Filters
            </button>
        </div>
    </div>
</div>

<!-- Role Distribution -->
<div class="role-distribution-section">
    <h2>Role Distribution</h2>
    <div class="role-cards">
        {% if user_metrics.role_distribution %}
            {% for role in user_metrics.role_distribution %}
            <div class="role-card">
                <div class="role-info">
                    <h3>{{ role._id|title }}</h3>
                    <p>{{ role.count }} users</p>
                </div>
                <div class="role-percentage">
                    {{ "%.1f"|format((role.count / user_metrics.total_users * 100) if user_metrics.total_users > 0 else 0) }}%
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-data">
                <p>No role data available</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Users Table -->
<div class="table-section">
    <div class="table-header">
        <h2>User Accounts</h2>
        <div class="table-actions">
            <button class="btn btn-sm btn-outline" onclick="refreshTable()">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
        </div>
    </div>
    
    <div class="table-container">
        <table class="users-table">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Age</th>
                    <th>Location</th>
                    <th>Role</th>
                    <th>Joined Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="users-table-body">
                {% if users_data.users and users_data.users|length > 0 %}
                    {% for user in users_data.users %}
                    <tr>
                        <td>
                            <div class="user-info">
                                <strong>{{ user.first_name or '' }} {{ user.last_name or '' }}</strong>
                                <br>
                                <small class="text-muted">{{ user.email or '' }}</small>
                            </div>
                        </td>
                        <td>{{ user.age or 'N/A' }}</td>
                        <td>{{ user.location or 'N/A' }}</td>
                        <td>
                            <select class="role-select" onchange="updateUserRole('{{ user._id }}', this.value)">
                                <option value="user" {% if user.role == 'user' %}selected{% endif %}>User</option>
                                <option value="news_reporter" {% if user.role == 'news_reporter' %}selected{% endif %}>News Reporter</option>
                                <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
                            </select>
                        </td>
                        <td>
                            {% if user.created_at %}
                                {{ user.created_at.strftime('%b %d, %Y') }}
                                <br><small>{{ user.created_at.strftime('%I:%M %p') }}</small>
                            {% else %}
                                Unknown
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline" onclick="viewUser('{{ user._id }}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline" onclick="editUser('{{ user._id }}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser('{{ user._id }}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="no-data">
                                <i class="fas fa-users"></i>
                                <h3>No Users Found</h3>
                                <p>No users match your current filters.</p>
                            </div>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if users_data.total_pages > 1 %}
    <div class="pagination-container" id="pagination-container">
        <div class="pagination">
            <button class="btn btn-sm" {% if not users_data.has_prev %}disabled{% endif %} onclick="loadUsersData({{ users_data.current_page - 1 }})">
                <i class="fas fa-chevron-left"></i>
                Previous
            </button>
            
            <div class="pagination-info">
                <span>Page {{ users_data.current_page }} of {{ users_data.total_pages }}</span>
                <span class="separator">|</span>
                <span>{{ users_data.total_count }} total users</span>
            </div>
            
            <button class="btn btn-sm" {% if not users_data.has_next %}disabled{% endif %} onclick="loadUsersData({{ users_data.current_page + 1 }})">
                Next
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize user management page
document.addEventListener('DOMContentLoaded', function() {
    initializeUserManagement();
});

function initializeUserManagement() {
    // Auto-refresh every 5 minutes
    setInterval(() => {
        if (document.visibilityState === 'visible') {
            refreshUsers();
        }
    }, 300000);
}

function filterUsers() {
    const role = document.getElementById('role-filter').value;
    const limit = document.getElementById('limit-select').value;
    
    loadUsersData(1, limit, role);
}

function changeLimit() {
    filterUsers();
}

function clearFilters() {
    document.getElementById('role-filter').value = 'all';
    document.getElementById('limit-select').value = '20';
    
    loadUsersData(1, 20, 'all');
}

function refreshUsers() {
    const currentFilters = {
        role: document.getElementById('role-filter').value,
        limit: document.getElementById('limit-select').value,
        page: 1
    };
    
    loadUsersData(currentFilters.page, currentFilters.limit, currentFilters.role);
}

function refreshTable() {
    refreshUsers();
}

function loadUsersData(page, limit, role) {
    if (typeof window.isLoading !== 'undefined' && window.isLoading) return;
    
    if (typeof window.showLoading === 'function') {
        window.showLoading();
    }
    
    var params = new URLSearchParams({
        page: page,
        limit: limit,
        role: role
    });
    
    fetch('/admin/users/data?' + params.toString())
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            updateUsersTable(data);
            updatePagination(data);
            
            // Update current page
            if (typeof currentPage !== 'undefined') {
                currentPage = page;
            }
        })
        .catch(function(error) {
            console.error('Failed to load users data:', error);
            if (typeof showNotification === 'function') {
                showNotification('Failed to load users data', 'error');
            }
        })
        .finally(function() {
            if (typeof window.hideLoading === 'function') {
                window.hideLoading();
            }
        });
}

function updateUsersTable(data) {
    const tableBody = document.getElementById('users-table-body');
    if (!tableBody) return;
    
    if (!data.users || data.users.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center">
                    <div class="no-data">
                        <i class="fas fa-users"></i>
                        <h3>No Users Found</h3>
                        <p>No users match your current filters.</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    var html = '';
    for (var i = 0; i < data.users.length; i++) {
        var user = data.users[i];
        var fullName = (user.first_name || '') + ' ' + (user.last_name || '');
        var email = user.email || '';
        var age = user.age || 'N/A';
        var location = user.location || 'N/A';
        var role = user.role || 'user';
        var createdDate = user.created_at ? new Date(user.created_at).toLocaleDateString() + '<br><small>' + new Date(user.created_at).toLocaleTimeString() + '</small>' : 'Unknown';
        
        html += '<tr>';
        html += '<td>';
        html += '<div class="user-info">';
        html += '<strong>' + escapeHtml(fullName) + '</strong>';
        html += '<br>';
        html += '<small class="text-muted">' + escapeHtml(email) + '</small>';
        html += '</div>';
        html += '</td>';
        html += '<td>' + age + '</td>';
        html += '<td>' + escapeHtml(location) + '</td>';
        html += '<td>';
        html += '<select class="role-select" onchange="updateUserRole(\'' + user._id + '\', this.value)">';
        html += '<option value="user"' + (role === 'user' ? ' selected' : '') + '>User</option>';
        html += '<option value="news_reporter"' + (role === 'news_reporter' ? ' selected' : '') + '>News Reporter</option>';
        html += '<option value="admin"' + (role === 'admin' ? ' selected' : '') + '>Admin</option>';
        html += '</select>';
        html += '</td>';
        html += '<td>';
        html += '<div class="date-cell">';
        html += createdDate;
        html += '</div>';
        html += '</td>';
        html += '<td>';
        html += '<div class="action-buttons">';
        html += '<button class="btn btn-sm btn-outline" onclick="viewUser(\'' + user._id + '\')" title="View Details">';
        html += '<i class="fas fa-eye"></i>';
        html += '</button>';
        html += '<button class="btn btn-sm btn-outline" onclick="editUser(\'' + user._id + '\')" title="Edit">';
        html += '<i class="fas fa-edit"></i>';
        html += '</button>';
        html += '<button class="btn btn-sm btn-danger" onclick="deleteUser(\'' + user._id + '\')" title="Delete">';
        html += '<i class="fas fa-trash"></i>';
        html += '</button>';
        html += '</div>';
        html += '</td>';
        html += '</tr>';
    }
    tableBody.innerHTML = html;
}

function updatePagination(data) {
    const paginationContainer = document.getElementById('pagination-container');
    if (!paginationContainer || data.total_pages <= 1) {
        if (paginationContainer) paginationContainer.style.display = 'none';
        return;
    }
    
    paginationContainer.style.display = 'block';
    
    const pagination = paginationContainer.querySelector('.pagination');
    const prevBtn = pagination.querySelector('button:first-child');
    const nextBtn = pagination.querySelector('button:last-child');
    const info = pagination.querySelector('.pagination-info');
    
    // Update button states
    prevBtn.disabled = !data.has_prev;
    nextBtn.disabled = !data.has_next;
    
    // Update info
    info.innerHTML = `
        <span>Page ${data.current_page} of ${data.total_pages}</span>
        <span class="separator">|</span>
        <span>${data.total_count} total users</span>
    `;
}

async function updateUserRole(userId, newRole) {
    try {
        const response = await fetch('/admin/users/update-role', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: userId,
                role: newRole
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (typeof showNotification === 'function') {
                showNotification('User role updated successfully', 'success');
            }
        } else {
            if (typeof showNotification === 'function') {
                showNotification(data.message || 'Failed to update user role', 'error');
            }
        }
    } catch (error) {
        console.error('Failed to update user role:', error);
        if (typeof showNotification === 'function') {
            showNotification('Failed to update user role', 'error');
        }
    }
}

async function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/admin/users/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: userId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (typeof showNotification === 'function') {
                showNotification('User deleted successfully', 'success');
            }
            // Refresh the table
            refreshUsers();
        } else {
            if (typeof showNotification === 'function') {
                showNotification(data.message || 'Failed to delete user', 'error');
            }
        }
    } catch (error) {
        console.error('Failed to delete user:', error);
        if (typeof showNotification === 'function') {
            showNotification('Failed to delete user', 'error');
        }
    }
}

function exportUsersData() {
    if (typeof showNotification === 'function') {
        showNotification('Export functionality coming soon', 'info');
    }
}

function viewUser(userId) {
    if (typeof showNotification === 'function') {
        showNotification('User details functionality coming soon', 'info');
    }
}

function editUser(userId) {
    if (typeof showNotification === 'function') {
        showNotification('Edit functionality coming soon', 'info');
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
